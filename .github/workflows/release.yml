name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g. v1.1.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve release tag
        id: release
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RAW_TAG="${{ inputs.tag }}"
          else
            RAW_TAG="${GITHUB_REF_NAME}"
          fi

          TAG="${RAW_TAG#refs/tags/}"
          VERSION="${TAG#v}"

          if ! echo "$TAG" | grep -Eq '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Invalid tag: $TAG"
            echo "Expected format: vX.Y.Z"
            exit 1
          fi

          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Update manifest version
        run: |
          jq --arg v "${{ steps.release.outputs.VERSION }}" '.version = $v' manifest.json > manifest.tmp.json
          mv manifest.tmp.json manifest.json

      - name: Build extension zip
        run: |
          ZIP_NAME="gerrit-jira-automation-${{ steps.release.outputs.TAG }}.zip"
          zip -r "$ZIP_NAME" \
            manifest.json \
            message_types.js \
            content_script.js \
            service_worker.js \
            popup.html \
            popup.js \
            options.html \
            options.js
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release.outputs.TAG }}
          name: "Gerrit Jira Tools ${{ steps.release.outputs.TAG }}"
          generate_release_notes: true
          files: ${{ env.ZIP_NAME }}
          body: |
            ## 설치 방법

            1. 아래 **Assets** 에서 `gerrit-jira-automation-${{ steps.release.outputs.TAG }}.zip` 다운로드
            2. Chrome 주소창에 `chrome://extensions` 입력
            3. 우측 상단 **개발자 모드** 켜기
            4. zip 파일 압축 해제 후 **압축 해제된 확장 프로그램 로드** 클릭
            5. 옵션 페이지에서 Jira URL / 이메일 / API 토큰 입력

            ---
